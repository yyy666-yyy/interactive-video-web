<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ç ´è¯‘â€œçº¢è‰²å¯†ç â€â€”EPOå…´å¥‹å‰‚çš„ç§‘å­¦çœŸç›¸ä¸é’å°‘å¹´è¿åŠ¨å‘˜çš„æŠ‰æ‹©</title>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000; /* Changed background for contrast */
      font-family: "Comic Sans MS", "Arial Rounded MT Bold", cursive; /* Keeping original font for now, can be changed */
    }
    video {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }
    /* Original Popup Styles (kept for reference/potential reuse) */
    .popup-box {
      display: none;
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      width: 90%;
      max-width: 440px;
      padding: 24px;
      background: linear-gradient(to bottom, #fdfdfd, #fef2d8);
      border: 6px solid #ff0000;
      border-radius: 24px;
      box-shadow: 0 0 12px 6px rgba(0,0,0,0.25), inset 0 0 6px #000;
      z-index: 10;
      animation: pop-in 0.4s ease-out;
      text-align: center;
    }
    .popup-box h2 {
      font-size: 22px;
      color: #0033cc;
      text-shadow: 2px 2px #fff;
    }
    .popup-box button {
      margin-top: 15px;
      padding: 12px 24px;
      background-color: #ffcc00;
      border: 3px solid #000;
      border-radius: 16px;
      color: #000;
      font-weight: bold;
      font-size: 16px;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 4px #cc9900;
    }
    .popup-box button:hover {
      background-color: #ffdd44;
      transform: scale(1.05);
    }
    .quiz-box button {
      display: block;
      margin: 10px auto;
      width: 80%;
    }
    #feedback {
      margin-top: 12px;
      font-size: 18px;
      font-weight: bold;
    }
    @keyframes pop-in {
      from {
        opacity: 0;
        transform: scale(0.7) translateX(-50%);
      }
      to {
        opacity: 1;
        transform: scale(1) translateX(-50%);
      }
    }
    .confetti {
      position: fixed;
      width: 12px;
      height: 12px;
      background-color: #ffcc00;
      top: -20px;
      animation: fall 3s linear infinite;
      z-index: 999;
      border-radius: 50%;
    }
    @keyframes fall {
      to {
        transform: translateY(110vh) rotate(360deg);
        opacity: 0;
      }
    }

    #qr-container {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      padding: 0;
      border: 6px solid #0033cc;
      border-radius: 20px;
      text-align: center;
      z-index: 999;
    }

    #qr-container img {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    #qr-download {
      display: inline-block;
      padding: 10px 20px;
      background: #ff3333;
      color: white;
      border-radius: 10px;
      text-decoration: none;
      font-weight: bold;
      border: 2px solid #000;
      margin-top: 10px;
    }

    #qr-download:hover {
      background: #ff6666;
    }

    #qr-container button {
      display: block;
      margin: 10px auto;
      padding: 10px 20px;
      background: #0033cc;
      color: white;
      border-radius: 10px;
      border: 2px solid #000;
      font-weight: bold;
      cursor: pointer;
    }

    #qr-container button:hover {
      background: #0055ff;
    }

    /* New Blackboard Popup Styles */
    .blackboard-popup {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8); /* Semi-transparent black overlay */
        z-index: 20;
        justify-content: center;
        align-items: center;
        text-align: center;
        color: #FFF; /* White text */
        font-family: inherit; /* Use the same font */
        padding: 20px;
        box-sizing: border-box;
    }

    .blackboard {
        background-color: #000; /* Black background for blackboard */
        border: 10px solid #ff0000; /* Red border */
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 0 15px 5px #ff0000; /* Red glow effect */
        width: 80%;
        max-width: 700px;
        position: relative; /* For character positioning */
        animation: pop-in 0.5s ease-out;
    }

    .blackboard-title {
        font-size: 28px;
        font-weight: bold;
        color: #ffff00; /* Yellow title */
        margin-bottom: 20px;
        text-shadow: 2px 2px #ff0000; /* Red shadow */
    }

    .blackboard-content {
        font-size: 18px;
        line-height: 1.6;
        text-align: left;
        margin-bottom: 30px;
        color: #FFF; /* White text */
    }
    .blackboard-content strong {
        display: block;
        text-align: center;
        font-weight: bold;
        color: #ffff00; /* Yellow for emphasized text */
        margin-bottom: 10px;
    }

    .blackboard-button {
        padding: 15px 30px;
        background-color: #ffff00; /* Yellow button */
        color: #000; /* Black text */
        border: 3px solid #ff0000; /* Red border */
        border-radius: 10px;
        font-size: 18px;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.2s ease;
        box-shadow: 0 5px #ff0000; /* Red shadow */
    }

    .blackboard-button:hover {
        background-color: #fff;
        color: #ff0000;
        transform: translateY(-2px);
        box-shadow: 0 7px #ff0000;
    }

    /* Animated Character Styles */
    .animated-character {
        position: absolute;
        bottom: 20px; /* Adjusted position */
        right: 20px; /* Adjust as needed */
        width: 100px; /* Adjusted size */
        height: 150px; /* Adjusted size */
        background-image: url('anime-character.png'); /* Using the anime character image */
        background-size: contain;
        background-repeat: no-repeat;
        background-position: center;
        border: none; /* Removed border */
        animation: character-bob 2s ease-in-out infinite; /* Kept animation */
    }

    /* Simple Bobbing Animation */
    @keyframes character-bob {
        0%, 100% {
            transform: translateY(0);
        }
        50% {
            transform: translateY(-10px); /* Adjust bob height */
        }
    }

    /* Quiz Styles */
    .quiz-container {
        max-height: 70vh;
        overflow-y: auto;
        padding-right: 15px; /* For scrollbar */
    }
    .quiz-question-box {
        background-color: #1a1a1a; /* Darker background for each question */
        border: 2px solid #ffff00; /* Yellow border */
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        text-align: left;
    }
    .quiz-question-box p {
        margin-bottom: 15px;
        font-size: 18px;
    }
    .quiz-option {
        display: block;
        width: 100%;
        padding: 10px;
        margin: 8px 0;
        background-color: #ff0000; /* Red options */
        color: #fff; /* White text */
        border: 2px solid #ffff00; /* Yellow border */
        border-radius: 8px;
        text-align: left;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .quiz-option:hover {
        background-color: #cc0000; /* Darker red on hover */
    }
    .quiz-feedback {
        margin-top: 15px;
        font-weight: bold;
        font-size: 16px;
    }
    .correct {
        color: #00ff00; /* Green for correct */
    }
    .incorrect {
        color: #ff0000; /* Red for incorrect */
    }
    .quiz-navigation {
        margin-top: 15px;
        color: #ffff00; /* Yellow text */
    }

    /* Celebration Effect */
    #celebration {
        display: none;
        position: fixed;
        top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.7);
        z-index: 1000;
        justify-content: center;
        align-items: center;
        text-align: center;
        flex-direction: column;
    }
    #celebration h2 {
        color: #ffff00;
        font-size: 3em;
        text-shadow: 3px 3px #ff0000;
        animation: celebration-text 1s ease-in-out infinite alternate;
    }
    @keyframes celebration-text {
        from { transform: scale(1); }
        to { transform: scale(1.1); }
    }

  </style>
</head>
<body>

<video id="video" controls>
  <!-- Ensure the video file path is correct -->
  <source src="ç ´è¯‘çº¢è‰²å¯†ç EPO.mp4" type="video/mp4" />
  ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒ video æ ‡ç­¾ã€‚
</video>

<!-- Original Popups (can be removed if not needed) -->
<div id="popup" class="popup-box">
  <h2>ç‚¹å‡»æ­å¼€EPOçœŸç›¸ï¼</h2>
  <button onclick="closePopup()">å¼€å§‹å§ï¼</button>
</div>
<div id="quiz" class="popup-box quiz-box">
  <h2>å…³äºEPOï¼ˆä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼‰çš„æè¿°ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š</h2>
  <button onclick="checkAnswer('A')">A. EPOæ˜¯ä¸€ç§åˆæ³•çš„è¿åŠ¨è¾…åŠ©è¯ç‰©ï¼Œå¯ä»¥å®‰å…¨åœ°ç”¨äºæé«˜è¿åŠ¨è¡¨ç°ã€‚</button>
  <button onclick="checkAnswer('B')">B. EPOèƒ½å¤Ÿåˆºæ¿€éª¨é«“åˆ¶é€ æ›´å¤šçš„çº¢ç»†èƒï¼Œä»è€Œå¢åŠ è¡€æ¶²çš„æºæ°§èƒ½åŠ›ã€‚</button>
  <button onclick="checkAnswer('C')">C. ä½¿ç”¨EPOä¸ä¼šå¯¹èº«ä½“é€ æˆä»»ä½•å‰¯ä½œç”¨ï¼Œæ˜¯ä¸€ç§ç†æƒ³çš„è€åŠ›å¢å¼ºå‰‚ã€‚</button>
  <button onclick="checkAnswer('D')">D. EPOçš„ä½¿ç”¨å¯¹è¿åŠ¨å‘˜æ¥è¯´åªæœ‰å¥½å¤„ï¼Œæ²¡æœ‰åå¤„ã€‚</button>
  <p id="feedback"></p>
</div>
<div id="finalPopup" class="popup-box">
  <h2>æ‹’ç»çº¢è‰²è¯±æƒ‘ï¼Œåšå®ˆå…¬å¹³ä¿¡ä»°</h2>
  <button onclick="showCommitment()">æˆ‘æ‰¿è¯ºï¼</button>
</div>
<div id="commitmentPopup" class="popup-box">
  <h2>å·²æˆåŠŸç­¾ç½²ç”µå­æ‰¿è¯ºä¹¦</h2>
  <button onclick="closeCommitment()">ç‚¹å‡»åŠ å…¥â€œSay No è¡ŒåŠ¨â€ï¼</button>
</div>
<div id="qr-container">
  <h2>æ­å–œä½ è·å¾—ã€ŒåEPOå¾½ç« ã€ï¼</h2>
  <img src="badge-image(1).png" alt="æ‰«æé¢†å–å¾½ç« ">
  <a id="qr-download" href="badge-image.png" download="åEPOå¾½ç« .png">ğŸ“¥ æ‰«ç é¢†å–æˆ–ç‚¹å‡»ä¸‹è½½å¾½ç« </a>
  <button onclick="closeQr()">è¿”å›è§†é¢‘</button>
</div>

<!-- New Blackboard Popups -->
<div id="knowledgePopup1" class="blackboard-popup">
  <div class="blackboard">
    <h2 class="blackboard-title">ã€ŠEPOçš„ç§‘å­¦çœŸç›¸ã€‹</h2>
    <div class="blackboard-content" data-speech="çŸ¥è¯†ç‚¹ä¸€ï¼šEPOçš„â€œä¸ªäººåç‰‡â€ã€‚ä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼ˆEPOï¼‰åˆç§°çº¢ç»†èƒåˆºæ¿€å› å­ã€ä¿ƒçº¢ç´ ï¼Œæ˜¯ä¸€ç§äººä½“å†…æºæ€§ç³–è›‹ç™½æ¿€ç´ ï¼Œå¯åˆºæ¿€çº¢ç»†èƒç”Ÿæˆã€‚">
      <strong>çŸ¥è¯†ç‚¹ä¸€ï¼šEPOçš„â€œä¸ªäººåç‰‡â€</strong>
      ä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼ˆEPOï¼‰åˆç§°çº¢ç»†èƒåˆºæ¿€å› å­ã€ä¿ƒçº¢ç´ ï¼Œæ˜¯ä¸€ç§äººä½“å†…æºæ€§ç³–è›‹ç™½æ¿€ç´ ï¼Œå¯åˆºæ¿€çº¢ç»†èƒç”Ÿæˆã€‚
    </div>
    <div class="animated-character"></div>
    <button class="blackboard-button" onclick="closeKnowledgePopup('knowledgePopup1')">å·²Getï¼ç»§ç»­æ’­æ”¾</button>
  </div>
</div>

<div id="knowledgePopup2" class="blackboard-popup">
  <div class="blackboard">
    <h2 class="blackboard-title">ã€ŠEPOçš„ç§‘å­¦çœŸç›¸ã€‹</h2>
    <div class="blackboard-content" data-speech="çŸ¥è¯†ç‚¹äºŒï¼šEPOçš„ä½œç”¨æœºç†ã€‚EPOä¸»è¦é€šè¿‡ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“â€œé”é’¥ç»“åˆâ€æ¥å‘æŒ¥å…¶ç”Ÿç‰©æ´»æ€§ã€‚">
      <strong>çŸ¥è¯†ç‚¹äºŒï¼šEPOçš„ä½œç”¨æœºç†</strong>
      EPOä¸»è¦é€šè¿‡ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“â€œé”é’¥ç»“åˆâ€æ¥å‘æŒ¥å…¶ç”Ÿç‰©æ´»æ€§ã€‚
    </div>
    <div class="animated-character"></div>
    <button class="blackboard-button" onclick="closeKnowledgePopup('knowledgePopup2')">å·²Getï¼ç»§ç»­æ’­æ”¾</button>
  </div>
</div>

<div id="knowledgePopup3" class="blackboard-popup">
  <div class="blackboard">
    <h2 class="blackboard-title">ã€ŠEPOçš„ç§‘å­¦çœŸç›¸ã€‹</h2>
    <div class="blackboard-content" data-speech="çŸ¥è¯†ç‚¹ä¸‰ï¼šEPOæ»¥ç”¨çš„ä»£ä»·ã€‚EPOæ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„å¥åº·é£é™©ï¼ŒåŒ…æ‹¬è¡€æ¶²çº¢ç»†èƒè¿‡å¤šï¼Œè¡€å‹è¿‡é«˜ï¼Œå¿ƒè„ç—…ã€ä¸­é£ç­‰ä¸€ç³»åˆ—æ— æ³•æŒ½å›çš„åæœã€‚">
      <strong>çŸ¥è¯†ç‚¹ä¸‰ï¼šEPOæ»¥ç”¨çš„ä»£ä»·</strong>
      EPOæ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„å¥åº·é£é™©ï¼ŒåŒ…æ‹¬è¡€æ¶²çº¢ç»†èƒè¿‡å¤šï¼Œè¡€å‹è¿‡é«˜ï¼Œå¿ƒè„ç—…ã€ä¸­é£ç­‰ä¸€ç³»åˆ—æ— æ³•æŒ½å›çš„åæœã€‚
    </div>
    <div class="animated-character"></div>
    <button class="blackboard-button" onclick="closeKnowledgePopup('knowledgePopup3')">å·²Getï¼ç»§ç»­æ’­æ”¾</button>
  </div>
</div>

<div id="summaryPopup" class="blackboard-popup">
  <div class="blackboard">
    <h2 class="blackboard-title">ã€Šè¯¾å ‚å°ç»“ã€‹</h2>
    <div class="blackboard-content" data-speech="è¯¾å ‚å°ç»“ã€‚çŸ¥è¯†ç‚¹ä¸€ã€EPOçš„â€œä¸ªäººåç‰‡â€ï¼šä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼ˆEPOï¼‰åˆç§°çº¢ç»†èƒåˆºæ¿€å› å­ã€ä¿ƒçº¢ç´ ï¼Œæ˜¯ä¸€ç§äººä½“å†…æºæ€§ç³–è›‹ç™½æ¿€ç´ ï¼Œå¯åˆºæ¿€çº¢ç»†èƒç”Ÿæˆã€‚çŸ¥è¯†ç‚¹äºŒã€EPOçš„ä½œç”¨æœºç†ï¼šEPOä¸»è¦é€šè¿‡ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“â€œé”é’¥ç»“åˆâ€æ¥å‘æŒ¥å…¶ç”Ÿç‰©æ´»æ€§ã€‚çŸ¥è¯†ç‚¹ä¸‰ã€EPOæ»¥ç”¨çš„ä»£ä»·ï¼šEPOæ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„å¥åº·é£é™©ï¼ŒåŒ…æ‹¬è¡€æ¶²çº¢ç»†èƒè¿‡å¤šï¼Œè¡€å‹è¿‡é«˜ï¼Œå¿ƒè„ç—…ã€ä¸­é£ç­‰ä¸€ç³»åˆ—æ— æ³•æŒ½å›çš„åæœã€‚">
      <strong>çŸ¥è¯†ç‚¹ä¸€ã€EPOçš„â€œä¸ªäººåç‰‡â€ï¼š</strong>ä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼ˆEPOï¼‰åˆç§°çº¢ç»†èƒåˆºæ¿€å› å­ã€ä¿ƒçº¢ç´ ï¼Œæ˜¯ä¸€ç§äººä½“å†…æºæ€§ç³–è›‹ç™½æ¿€ç´ ï¼Œå¯åˆºæ¿€çº¢ç»†èƒç”Ÿæˆã€‚<br><br>
      <strong>çŸ¥è¯†ç‚¹äºŒã€EPOçš„ä½œç”¨æœºç†ï¼š</strong>EPOä¸»è¦é€šè¿‡ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“â€œé”é’¥ç»“åˆâ€æ¥å‘æŒ¥å…¶ç”Ÿç‰©æ´»æ€§ã€‚<br><br>
      <strong>çŸ¥è¯†ç‚¹ä¸‰ã€EPOæ»¥ç”¨çš„ä»£ä»·ï¼š</strong>EPOæ»¥ç”¨ä¼šå¯¼è‡´ä¸¥é‡çš„å¥åº·é£é™©ï¼ŒåŒ…æ‹¬è¡€æ¶²çº¢ç»†èƒè¿‡å¤šï¼Œè¡€å‹è¿‡é«˜ï¼Œå¿ƒè„ç—…ã€ä¸­é£ç­‰ä¸€ç³»åˆ—æ— æ³•æŒ½å›çš„åæœã€‚
    </div>
    <div class="animated-character"></div>
    <button class="blackboard-button" onclick="closeKnowledgePopup('summaryPopup')">å·²Getå…¨éƒ¨è¯¾å ‚çŸ¥è¯†ç‚¹ï¼ç»§ç»­æ’­æ”¾</button>
  </div>
</div>

<!-- New Quiz Popup -->
<div id="finalQuizPopup" class="blackboard-popup">
  <div class="blackboard">
    <h2 class="blackboard-title">è¯¾å ‚ç»ƒä¹ </h2>
    <div class="quiz-container" id="quizContainer">
      <!-- Quiz questions will be loaded here by JavaScript -->
    </div>
    <button class="blackboard-button" id="quizCloseButton" style="display: none;" onclick="closeKnowledgePopup('finalQuizPopup')">å®Œæˆç»ƒä¹ ï¼ç»§ç»­è§‚çœ‹</button>
  </div>
</div>

<!-- Celebration Effect -->
<div id="celebration">
    <h2>æ­å–œä½ ï¼ï¼ï¼</h2>
    <p style="color: white; font-size: 1.5em;">ä½ å·²å®Œæˆå…¨éƒ¨è¯¾å ‚å†…å®¹å’Œä¹ é¢˜ï¼</p>
</div>

<script>
  const video = document.getElementById("video");
  // Original popup elements
  const popup = document.getElementById("popup");
  const quiz = document.getElementById("quiz");
  const finalPopup = document.getElementById("finalPopup");
  const commitmentPopup = document.getElementById("commitmentPopup");
  const feedback = document.getElementById("feedback");
  const qrContainer = document.getElementById("qr-container");
  const qrDownload = document.getElementById("qr-download");

  // New popup elements
  const knowledgePopup1 = document.getElementById("knowledgePopup1");
  const knowledgePopup2 = document.getElementById("knowledgePopup2");
  const knowledgePopup3 = document.getElementById("knowledgePopup3");
  const summaryPopup = document.getElementById("summaryPopup");
  const finalQuizPopup = document.getElementById("finalQuizPopup");
  const quizContainer = document.getElementById("quizContainer");
  const quizCloseButton = document.getElementById("quizCloseButton");
  const celebrationEffect = document.getElementById("celebration");

  // Tracking variables for original popups
  let popupShown = false;
  let quizShown = false;
  let finalPopupShown = false;
  let firstQRTriggered = false;
  let hasInteractedWithQR = false;
  let lastVideoTime = 0;

  // Tracking variables for new popups
  let knowledgePopup1Shown = false;
  let knowledgePopup2Shown = false;
  let knowledgePopup3Shown = false;
  let summaryPopupShown = false;
  let finalQuizPopupShown = false;

  // --- Speech Synthesis Setup ---
  const synth = window.speechSynthesis;
  let voices = [];
  let speechUtterance = null; // To hold the current utterance

  function populateVoiceList() {
    if(typeof speechSynthesis === 'undefined') {
      console.warn('Speech Synthesis not supported');
      return;
    }
    voices = synth.getVoices().filter(voice => voice.lang.startsWith('zh'));
    // console.log(voices); // Optional: Log available Chinese voices
  }

  populateVoiceList();
  if (typeof speechSynthesis !== 'undefined' && speechSynthesis.onvoiceschanged !== undefined) {
    speechSynthesis.onvoiceschanged = populateVoiceList;
  }

  // --- Quiz Data --- 
  const quizData = [
    {
      type: 'choice',
      question: 'å…³äºEPOï¼ˆä¿ƒçº¢ç»†èƒç”Ÿæˆç´ ï¼‰çš„æè¿°ï¼Œä»¥ä¸‹è¯´æ³•æ­£ç¡®çš„æ˜¯ï¼š',
      options: [
        'A. EPOæ˜¯ä¸€ç§åˆæ³•çš„è¿åŠ¨è¾…åŠ©è¯ç‰©ï¼Œå¯ä»¥å®‰å…¨åœ°ç”¨äºæé«˜è¿åŠ¨è¡¨ç°ã€‚',
        'B. EPOèƒ½å¤Ÿåˆºæ¿€éª¨é«“åˆ¶é€ æ›´å¤šçš„çº¢ç»†èƒï¼Œä»è€Œå¢åŠ è¡€æ¶²çš„æºæ°§èƒ½åŠ›ã€‚',
        'C. ä½¿ç”¨EPOä¸ä¼šå¯¹èº«ä½“é€ æˆä»»ä½•å‰¯ä½œç”¨ï¼Œæ˜¯ä¸€ç§ç†æƒ³çš„è€åŠ›å¢å¼ºå‰‚ã€‚',
        'D. EPOçš„ä½¿ç”¨å¯¹è¿åŠ¨å‘˜æ¥è¯´åªæœ‰å¥½å¤„ï¼Œæ²¡æœ‰åå¤„ã€‚'
      ],
      answer: 'B',
      explanation: 'Bé€‰é¡¹æ­£ç¡®æè¿°äº†EPOçš„ä¸»è¦ç”Ÿç†åŠŸèƒ½ã€‚Aé€‰é¡¹é”™è¯¯ï¼ŒEPOå±äºå…´å¥‹å‰‚ï¼Œæ˜¯è¢«ç¦æ­¢çš„ï¼›Cå’ŒDé€‰é¡¹é”™è¯¯ï¼Œæ»¥ç”¨EPOæœ‰ä¸¥é‡çš„å¥åº·é£é™©ã€‚'
    },
    {
      type: 'choice',
      question: 'EPOçš„åˆ«åä¸åŒ…æ‹¬ï¼š',
      options: [
        'A. ä¿ƒçº¢ç´ ',
        'B. çº¢ç»†èƒåˆºæ¿€å› å­',
        'C. ç”Ÿé•¿æ¿€ç´ ',
        'D. ä¿ƒçº¢ç»†èƒç”Ÿæˆç´ '
      ],
      answer: 'C',
      explanation: 'æ ¹æ®çŸ¥è¯†ç‚¹ä¸€ï¼ŒEPOçš„åˆ«ååŒ…æ‹¬çº¢ç»†èƒåˆºæ¿€å› å­å’Œä¿ƒçº¢ç´ ï¼Œç”Ÿé•¿æ¿€ç´ ä¸æ˜¯EPOçš„åˆ«åã€‚'
    },
    {
      type: 'choice',
      question: 'EPOæ»¥ç”¨å¯èƒ½å¯¼è‡´çš„åæœæœ‰ï¼š',
      options: [
        'A. è¡€å‹è¿‡é«˜å’Œå¿ƒè„ç—…',
        'B. è´«è¡€å’Œä½è¡€å‹',
        'C. é£Ÿæ¬²ä¸æŒ¯',
        'D. è§†åŠ›ä¸‹é™'
      ],
      answer: 'A',
      explanation: 'æ ¹æ®çŸ¥è¯†ç‚¹ä¸‰ï¼ŒEPOæ»¥ç”¨ä¼šå¯¼è‡´è¡€å‹è¿‡é«˜å’Œå¿ƒè„ç—…ç­‰ä¸¥é‡åæœã€‚'
    },
    {
      type: 'true_false',
      question: 'EPOé€šè¿‡"é”é’¥ç»“åˆ"çš„æ–¹å¼ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“ç»“åˆæ¥å‘æŒ¥ä½œç”¨ã€‚',
      answer: true,
      explanation: 'æ ¹æ®çŸ¥è¯†ç‚¹äºŒï¼ŒEPOç¡®å®æ˜¯é€šè¿‡ä¸çº¢ç³»ç¥–ç»†èƒè¡¨é¢çš„ç‰¹å¼‚æ€§å—ä½“"é”é’¥ç»“åˆ"æ¥å‘æŒ¥å…¶ç”Ÿç‰©æ´»æ€§ã€‚'
    },
    {
      type: 'true_false',
      question: 'EPOæ»¥ç”¨å¯¹äººä½“æ²¡æœ‰ä»»ä½•å±å®³ã€‚',
      answer: false,
      explanation: 'æ ¹æ®çŸ¥è¯†ç‚¹ä¸‰ï¼ŒEPOæ»¥ç”¨ä¼šå¯¼è‡´å¤šç§ä¸¥é‡çš„å¥åº·é£é™©ï¼ŒåŒ…æ‹¬è¡€æ¶²çº¢ç»†èƒè¿‡å¤šã€è¡€å‹è¿‡é«˜ã€å¿ƒè„ç—…å’Œä¸­é£ç­‰ã€‚'
    }
  ];

  let currentQuestionIndex = 0;
  let quizCompleted = false;

  // --- Event Listener for Video Time Updates ---
  video.ontimeupdate = function () {
    if (quizCompleted) return; // Stop checking time if quiz is done
    const time = video.currentTime;

    // Timestamps converted to seconds (MM:SS.ms -> seconds)
    const timeKp1 = 14.25; // 00:14.25
    const timeKp2 = 79.81; // 01:19.81
    const timeKp3 = 100.62; // 01:40.62
    const timeSummary = 123.57; // 02:03.57
    const timeFinalQuiz = 195.21; // 03:15.21

    // Original popup triggers (kept for now)
    if (time >= 59.31 && !popupShown) { // 00:59.31
      video.pause();
      popup.style.display = 'block';
      popupShown = true;
    }
    // åˆ é™¤äº†01:49.54æ—¶é—´ç‚¹çš„é€‰æ‹©é¢˜äº¤äº’å¼¹çª—
    if (time >= 174.76 && !finalPopupShown) { // 02:54.76
      video.pause();
      finalPopup.style.display = 'block';
      finalPopupShown = true;
    }
    if (time >= 182.41 && time < 183 && !hasInteractedWithQR && !firstQRTriggered) { // 03:02.41
      showQr(false);
      firstQRTriggered = true;
    }

    // New popup triggers
    if (time >= timeKp1 && !knowledgePopup1Shown) {
      showKnowledgePopup('knowledgePopup1');
      knowledgePopup1Shown = true;
    }
    if (time >= timeKp2 && !knowledgePopup2Shown) {
      showKnowledgePopup('knowledgePopup2');
      knowledgePopup2Shown = true;
    }
    if (time >= timeKp3 && !knowledgePopup3Shown) {
      showKnowledgePopup('knowledgePopup3');
      knowledgePopup3Shown = true;
    }
    if (time >= timeSummary && !summaryPopupShown) {
      showKnowledgePopup('summaryPopup');
      summaryPopupShown = true;
    }
    // æœ€ç»ˆæµ‹éªŒå¼¹çª—ä¸å†ä½¿ç”¨å›ºå®šæ—¶é—´ç‚¹è§¦å‘ï¼Œè€Œæ˜¯åœ¨å…³é—­è¯¾å ‚å°ç»“å¼¹çª—åè§¦å‘
  };

  video.onended = function () {
    if (!quizCompleted) {
        // If video ends before quiz is triggered/completed, show quiz
        showKnowledgePopup('finalQuizPopup');
        if (!finalQuizPopupShown) {
            loadQuizQuestion(currentQuestionIndex);
            finalQuizPopupShown = true;
        }
    } else {
        // Or show the original QR code if quiz is done
        showQr(true);
    }
  };

  // --- Functions for Original Popups ---
  function closePopup() {
    playClickSound(); // Add click sound
    popup.style.display = 'none';
    video.play();
  }
  function checkAnswer(answer) { // Original quiz logic
    if (answer === 'B') {
      feedback.textContent = 'BINGOï¼ç­”å¯¹å•¦ ğŸ‰';
      feedback.style.color = '#00aa00';
      showConfetti();
      setTimeout(() => {
        quiz.style.display = 'none';
        video.play();
      }, 1500);
    } else {
      feedback.textContent = 'é”™è¯¯ï¼è§£æï¼š' + getExplanation(answer);
      feedback.style.color = 'red';
    }
  }
  function getExplanation(answer) { // Original explanation logic
    const explanations = {
      'A': 'EPOå±äºå…´å¥‹å‰‚ï¼Œæ˜¯è¢«å›½é™…ä½“è‚²ç»„ç»‡æ˜ä»¤ç¦æ­¢çš„éæ³•è¯ç‰©ã€‚',
      'C': 'ä½¿ç”¨EPOä¼šå¯¼è‡´ä¸¥é‡çš„å‰¯ä½œç”¨ï¼Œå¦‚è¡€æ¶²æµ“ç¨ ã€è¡€æ “å½¢æˆç­‰ã€‚',
      'D': 'EPOçš„ä½¿ç”¨å¯¹è¿åŠ¨å‘˜æ¥è¯´æœ‰ä¸¥é‡çš„å¥åº·é£é™©ã€‚'
    };
    return explanations[answer] || '';
  }
  function showCommitment() {
    finalPopup.style.display = 'none';
    commitmentPopup.style.display = 'block';
  }
  function closeCommitment() {
    commitmentPopup.style.display = 'none';
    video.play();
  }
  function showQr(showFull) {
    qrContainer.style.display = 'block';
    video.pause();
    lastVideoTime = video.currentTime;
    qrDownload.style.display = showFull ? 'inline-block' : 'none';
  }
  function closeQr() {
    qrContainer.style.display = 'none';
    hasInteractedWithQR = true;
    video.currentTime = lastVideoTime;
    video.play();
  }
  function showConfetti() { // Original confetti
    for (let i = 0; i < 40; i++) {
      const confetti = document.createElement('div');
      confetti.classList.add('confetti');
      confetti.style.left = Math.random() * 100 + 'vw';
      confetti.style.backgroundColor = randomColor();
      confetti.style.animationDuration = (Math.random() * 2 + 2) + 's';
      document.body.appendChild(confetti);
      setTimeout(() => confetti.remove(), 3000);
    }
  }
  function randomColor() { // Original random color
    const colors = ['#ffcc00', '#ff6666', '#66ccff', '#0033cc', '#ff0000'];
    return colors[Math.floor(Math.random() * colors.length)];
  }

  // --- Sound Effect Functions ---
  function playClickSound() {
    const clickSound = new Audio("button_click.mp3");
    clickSound.play();
  }

  function playNotificationSound() {
    const notificationSound = new Audio("notification_popup.mp3");
    notificationSound.play();
  }

  function playCorrectAnswerSound() { // New function for correct answer sound
    const correctSound = new Audio("correct_answer_applause.mp3");
    correctSound.play();
  }

  // --- Functions for New Popups ---
  function showKnowledgePopup(popupId) {
    const popupElement = document.getElementById(popupId);
    if (popupElement) {
      playNotificationSound(); // Play notification sound when popup appears
      video.pause();
      popupElement.style.display = "flex"; // Use flex for centering
      
      // Trigger speech synthesis for knowledge/summary popups
      if (popupId.startsWith("knowledge") || popupId === "summaryPopup") {
          const contentElement = popupElement.querySelector("[data-speech]");
          if (contentElement) {
              const textToSpeak = contentElement.getAttribute("data-speech");
              // No callback needed here as we don't need to do anything after speech
              speakText(textToSpeak);
          }
      }
    }
  }

  function closeKnowledgePopup(popupId) {
    playClickSound(); // Play click sound when closing
    const popupElement = document.getElementById(popupId);
    if (popupElement) {
      popupElement.style.display = "none";
      // Stop speech synthesis when closing popup
      if (synth.speaking) {
          synth.cancel();
      }

      // å¦‚æœå…³é—­çš„æ˜¯è¯¾å ‚å°ç»“å¼¹çª—ï¼Œåˆ™æ˜¾ç¤ºæœ€ç»ˆæµ‹éªŒå¼¹çª—
      if (popupId === "summaryPopup" && !finalQuizPopupShown) {
          setTimeout(() => {
              showKnowledgePopup('finalQuizPopup'); // showKnowledgePopup already plays notification sound
              loadQuizQuestion(currentQuestionIndex);
              finalQuizPopupShown = true;
          }, 500); // çŸ­æš‚å»¶è¿Ÿåæ˜¾ç¤ºæµ‹éªŒå¼¹çª—
      } else if (!quizCompleted || popupId !== "finalQuizPopup") { // å…¶ä»–æƒ…å†µä¸‹ç»§ç»­æ’­æ”¾è§†é¢‘
          video.play();
      }
    }
  }

  // --- Speech Synthesis Function ---
  // Add callback parameter
  function speakText(text, callback) {
    if (synth.speaking) {
        // console.log('SpeechSynthesis is busy, cancelling previous speech.');
        synth.cancel(); // Cancel previous speech if any
        // Use a small timeout to allow cancellation to complete before starting new speech
        // Pass the callback to the new startSpeaking call
        setTimeout(() => { startSpeaking(text, callback); }, 100);
        return;
    }
    // Pass the callback to startSpeaking
    startSpeaking(text, callback);
  }

  // Add callback parameter
  function startSpeaking(text, callback) {
    if (text !== "") {
        speechUtterance = new SpeechSynthesisUtterance(text);
        speechUtterance.onend = function (event) {
            // console.log("SpeechSynthesisUtterance.onend");
            speechUtterance = null; // Clear utterance when finished
            // Execute the callback function if it exists
            if (typeof callback === "function") {
                callback();
            }
        }
        speechUtterance.onerror = function (event) {
            console.error("SpeechSynthesisUtterance.onerror", event);
            speechUtterance = null;
            // Optionally call callback even on error, or handle differently
            // if (typeof callback === "function") {
            //     callback(); 
            // }
        }
        
        // Try to find a suitable Chinese voice (preference for female/youthful if possible)
        let selectedVoice = voices.find(voice => voice.lang === "zh-CN" && voice.name.includes("Xiaoyi")) || // Common youthful voice name
                          voices.find(voice => voice.lang === "zh-CN" && voice.name.includes("Female")) ||
                          voices.find(voice => voice.lang === "zh-CN") || // Any Chinese voice
                          voices.find(voice => voice.lang.startsWith("zh")); // Any Chinese variant

        if (selectedVoice) {
            speechUtterance.voice = selectedVoice;
            // console.log("Using voice:", selectedVoice.name);
        } else {
            console.warn("No suitable Chinese voice found, using default.");
        }
        
        // Optional: Adjust pitch and rate
        // speechUtterance.pitch = 1; 
        // speechUtterance.rate = 1;

        synth.speak(speechUtterance);
    }
  }


  // --- Quiz Logic Functions ---
  function loadQuizQuestion(index) {
    if (index >= quizData.length) {
      completeQuiz();
      return;
    }

    const questionData = quizData[index];
    quizContainer.innerHTML = ''; // Clear previous question

    const questionBox = document.createElement('div');
    questionBox.className = 'quiz-question-box';

    const questionText = document.createElement('p');
    questionText.textContent = `ç¬¬ ${index + 1} é¢˜: ${questionData.question}`;
    questionBox.appendChild(questionText);

    if (questionData.type === 'choice') {
      questionData.options.forEach(optionText => {
        const button = document.createElement('button');
        button.className = 'quiz-option';
        button.textContent = optionText;
        const choice = optionText.split('')[0]; // Get A, B, C, or D
        button.onclick = () => { playClickSound(); handleAnswer(choice, questionData.answer, questionData.explanation, questionBox); };
        questionBox.appendChild(button);
      });
    } else if (questionData.type === 'true_false') {
      const trueButton = document.createElement('button');
      trueButton.className = 'quiz-option';
      trueButton.textContent = 'å¯¹';
      trueButton.onclick = () => { playClickSound(); handleAnswer(true, questionData.answer, questionData.explanation, questionBox); };
      questionBox.appendChild(trueButton);

      const falseButton = document.createElement('button');
      falseButton.className = 'quiz-option';
      falseButton.textContent = 'é”™';
      falseButton.onclick = () => { playClickSound(); handleAnswer(false, questionData.answer, questionData.explanation, questionBox); };
      questionBox.appendChild(falseButton);
    }

    const feedbackElement = document.createElement('p');
    feedbackElement.className = 'quiz-feedback';
    questionBox.appendChild(feedbackElement);

    const navigationElement = document.createElement('p');
    navigationElement.className = 'quiz-navigation';
    navigationElement.style.display = 'none'; // Hide initially
    navigationElement.textContent = 'è¯·ç»§ç»­ä½œç­”ä¸‹ä¸€é¢˜...';
    questionBox.appendChild(navigationElement);

    quizContainer.appendChild(questionBox);
    quizContainer.scrollTop = quizContainer.scrollHeight; // Scroll to the new question
  }

  function handleAnswer(selectedAnswer, correctAnswer, explanation, questionBox) {
    const feedbackElement = questionBox.querySelector("p.quiz-feedback");
    const navigationElement = questionBox.querySelector("p.quiz-navigation");
    const buttons = questionBox.querySelectorAll("button.quiz-option");

    // Disable buttons after answering
    buttons.forEach(button => button.disabled = true);

    let correctSpeech = "ç­”å¯¹äº†ï¼çœŸä¸é”™ï¼ä¸ºä½ é¼“æŒï¼";
    let incorrectSpeech = "ä¸å¯¹å“¦ï¼Œå›é¡¾ä¸€ä¸‹çŸ¥è¯†ç‚¹ï¼Œå†è¯•è¯•ï¼";

    // ä¸ºç¬¬ä¸€é¢˜å®šåˆ¶æ’­æŠ¥å†…å®¹
    if (currentQuestionIndex === 0) {
        correctSpeech = "ç­”å¯¹äº†ï¼Bé€‰é¡¹æ­£ç¡®æè¿°äº†EPOçš„ä¸»è¦ç”Ÿç†åŠŸèƒ½ã€‚";
        // å¯¹äºç¬¬ä¸€é¢˜çš„é”™è¯¯å›ç­”ï¼Œæ’­æŠ¥è§£æå†…å®¹
        incorrectSpeech = "ä¸å¯¹å“¦ã€‚æ­£ç¡®ç­”æ¡ˆæ˜¯Bã€‚è§£æï¼š" + explanation;
    }

    // æ£€æŸ¥ç­”æ¡ˆ (æ³¨æ„ï¼šåŸå§‹ç¬¬ä¸€é¢˜ç­”æ¡ˆæ˜¯Bï¼Œåç»­é¢˜ç›®å¯èƒ½æœ‰ä¸åŒç±»å‹ç­”æ¡ˆ)
    let isCorrect = false;
    if (Array.isArray(correctAnswer)) { // å¤„ç†å¤šé€‰é¢˜
        // æ³¨æ„ï¼šå½“å‰ä»£ç æœªå®Œå…¨æ”¯æŒå¤šé€‰é€»è¾‘åˆ¤æ–­ï¼Œè¿™é‡Œä»…ä½œç¤ºä¾‹
        isCorrect = correctAnswer.includes(String(selectedAnswer)); 
    } else { // å¤„ç†å•é€‰æˆ–åˆ¤æ–­é¢˜
        isCorrect = String(selectedAnswer) === String(correctAnswer);
    }

    if (isCorrect) {
      playCorrectAnswerSound(); // Play sound for correct answer
      feedbackElement.textContent = "æ­£ç¡®ï¼ğŸ‘ å¹²å¾—æ¼‚äº®ï¼" + explanation;
      feedbackElement.className = "quiz-feedback correct";
      
      const nextAction = () => {
          currentQuestionIndex++;
          if (currentQuestionIndex < quizData.length) {
              navigationElement.style.display = "block";
              loadQuizQuestion(currentQuestionIndex); 
          } else {
              completeQuiz();
          }
      };

      speakText(correctSpeech, nextAction);

    } else {
      feedbackElement.textContent = "é”™è¯¯ï¼ğŸ˜¥ å†è¯•ä¸€æ¬¡å§ï¼è§£æï¼š" + explanation;
      feedbackElement.className = "quiz-feedback incorrect";
      speakText(incorrectSpeech);
      // å…è®¸é‡è¯•
      buttons.forEach(button => button.disabled = false);
    }
  }

  function completeQuiz() {
    quizCompleted = true;
    quizContainer.innerHTML = '<h3 style="color: #00ff00;">æ‰€æœ‰é¢˜ç›®å·²å®Œæˆï¼</h3>';
    quizCloseButton.style.display = 'block'; // Show close button
    showCelebration();
    // Pass a callback to ensure UI actions happen after speech completes
    speakText('æ­å–œä½ ï¼å·²å®Œæˆå…¨éƒ¨è¯¾å ‚å†…å®¹å’Œä¹ é¢˜ï¼', () => {
      // Optional: Any actions that should happen after completion speech ends
      console.log("Quiz completion speech finished");
    });
  }

  function showCelebration() {
      celebrationEffect.style.display = 'flex';
      // Play sound effect
      const celebrationSound = new Audio('celebration_applause.mp3');
      celebrationSound.play();
      // Optional: Hide after a few seconds
      setTimeout(() => {
          celebrationEffect.style.display = 'none';
      }, 4000); // Display for 4 seconds
  }

</script>

</body>
</html>
